(()=>{"use strict";function t(t){const e=t.getBoundingClientRect();return e.top<=window.innerHeight&&e.left<=window.innerWidth}function e(t){return"none"===getComputedStyle(t).display||!t.textContent||""===t.textContent.trim()}function n(t){const e=t.childNodes;if(0===e.length)return!1;for(const t of e)if(t.nodeType===Node.TEXT_NODE&&t.nodeValue&&""!==t.nodeValue.trim())return!0;return!1}function s(t){const e=t.children;return!(!e||0===e.length)&&Array.from(e).every((t=>{const e=getComputedStyle(t).display;return t.textContent&&""!==t.textContent.trim()&&"BASE"!==t.tagName&&"LINK"!==t.tagName&&"NOSCRIPT"!==t.tagName&&"SCRIPT"!==t.tagName&&"STYLE"!==t.tagName&&"TEMPLATE"!==t.tagName&&"TITLE"!==t.tagName&&"AUDIO"!==t.tagName&&"CANVAS"!==t.tagName&&"IMG"!==t.tagName&&"MATH"!==t.tagName&&"OBJECT"!==t.tagName&&"PICTURE"!==t.tagName&&"SVG"!==t.tagName&&"VIDEO"!==t.tagName&&"block"!==e&&"flex"!==e&&"table-row"!==e&&"table-cell"!==e&&"none"!==e}))}function a(t,e){i(t,e),e.add(t)}function o(t,e,n){i(t,e),e.set(t,n)}function i(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function r(t,e){return function(t,e){if(e.get)return e.get.call(t);return e.value}(t,c(t,e,"get"))}function l(t,e,n){return function(t,e,n){if(e.set)e.set.call(t,n);else{if(!e.writable)throw new TypeError("attempted to set read only private field");e.value=n}}(t,c(t,e,"set"),n),n}function c(t,e,n){if(!e.has(t))throw new TypeError("attempted to "+n+" private field on non-instance");return e.get(t)}function d(t,e,n){if(!e.has(t))throw new TypeError("attempted to get private field on non-instance");return n}var u=new WeakMap,g=new WeakMap,h=new WeakMap,w=new WeakMap,m=new WeakMap,f=new WeakMap,b=new WeakMap,v=new WeakMap,p=new WeakMap,T=new WeakMap,y=new WeakSet,S=new WeakSet,L=new WeakSet,E=new WeakSet,k=new WeakSet,M=new WeakSet,N=new WeakSet,A=new WeakSet,W=new WeakSet,I=new WeakSet,x=new WeakSet,C=new WeakSet,O=new WeakSet,_=new WeakSet,B=new WeakSet,R=new WeakSet,H=new WeakSet;function P(){d(this,S,j).call(this);const t=d(this,x,Y).call(this);t&&t.remove();const e=document.getElementById("translate-button");e&&e.remove(),l(this,f,d(this,A,q).call(this)),l(this,b,d(this,W,X).call(this)),d(this,E,$).call(this),("ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0)&&d(this,k,D).call(this)}function j(){const t="__wtdl-global-data",e=document.getElementById(t);if(e){if(e.dataset.wtdlOriginalTexts)try{l(this,w,JSON.parse(e.dataset.wtdlOriginalTexts))}catch(t){}}else document.body.insertAdjacentHTML("beforeend",`<div id="${t}" style="display: none;"></div>`)}function V(){const t=document.getElementById("__wtdl-global-data");t&&(t.dataset.wtdlOriginalTexts=JSON.stringify(r(this,w)))}function $(){browser.runtime.onMessage.addListener((async(t,e,n)=>{if(t)switch(t.method){case"translate":l(this,p,!0),await d(this,O,z).call(this,t),function(t,e){let n;return function(){return t&&(n=t.apply(e||this,arguments),t=void 0),n}}(function(t){let e,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:200;window.addEventListener("scroll",(function(s){window.clearTimeout(e),e=setTimeout(t,n)}),{once:!1,passive:!0,capture:!0})}((async()=>{r(this,p)&&await d(this,O,z).call(this,{sourceLanguage:r(this,g),targetLanguage:r(this,h)})}),500))(),n();break;case"getContentState":r(this,v)?n({result:{isProcessing:r(this,v)}}):Object.keys(r(this,w)).length>0?n({result:{sourceLanguage:r(this,g),targetLanguage:r(this,h),isShowingOriginal:r(this,T)}}):n(void 0);break;case"showOriginal":{l(this,p,!1),l(this,T,!0);const t=document.querySelectorAll('[data-wtdl-translated="true"]');for(const e of t){const t=e.dataset.wtdlUid,n=r(this,w)[t];void 0!==n&&(e.innerHTML=n,e.dataset.wtdlTranslated="false")}n();break}case"startTranslateSelection":{const t=window.getSelection();let e=d(this,C,G).call(this);if(!e&&t.rangeCount){const n=t.getRangeAt(0).getBoundingClientRect();e={x:n.left+window.scrollX,y:n.bottom+window.scrollY+30}}d(this,I,F).call(this,e).setAttribute("loading",!0),n();break}case"finishTranslateSelection":{const e=t.result,s=d(this,x,Y).call(this);if(s){if(e.result&&e.result.texts){const n=e.result.texts.map((t=>t.text)).join("\n");s.setAttribute("result",`${n}`),s.setAttribute("lang",`${t.targetLanguage||""}`)}else if(e.error){const t=browser.i18n.getMessage("error_message_generic_error");s.setAttribute("error",t)}else{const t=browser.i18n.getMessage("error_message_generic_error");s.setAttribute("error",t)}s.setAttribute("loading",!1)}n();break}case"getSelection":{const t=window.getSelection();n({result:t?t.toString():void 0});break}default:n()}})),browser.storage.onChanged.addListener(((t,e)=>{if("local"===e&&"selectedTargetLanguage"in t){const e=d(this,x,Y).call(this);e&&(e.setAttribute("lang",t.selectedTargetLanguage.newValue),browser.runtime.sendMessage({method:"translateSelection",selectionText:void 0}))}}))}function D(){document.addEventListener("pointerup",(async t=>{t.preventDefault();const e=window.getSelection();if(!e.rangeCount)return;let n=e.getRangeAt(0).cloneRange();const s=e?e.toString().trim():"";s||e.rangeCount?setTimeout((()=>{n=e.rangeCount?e.getRangeAt(0).cloneRange():n,n.collapse(e.anchorOffset>e.focusOffset);const t=n.getBoundingClientRect(),a=t.right+window.scrollX-20,o=t.bottom+window.scrollY+40;{const t=window.getSelection();if(!t||!t.toString().trim())return void d(this,N,J).call(this)}browser.storage.local.get(["settingsShowsIconForReading"],(t=>{if(void 0===t.settingsShowsIconForReading||t.settingsShowsIconForReading){const t=d(this,M,U).call(this,{x:a,y:o});t.addEventListener("tooltipClick",(e=>(e.preventDefault(),e.stopPropagation(),s&&browser.runtime.sendMessage({method:"translateSelection",selectionText:s}),t.remove(),!1)))}}))}),100):d(this,N,J).call(this)}))}function U(t){const e="translate-button";{const t=document.getElementById(e);t&&t.remove()}document.body.insertAdjacentHTML("beforeend",`<translate-button id="${e}"></translate-button>`);const n=document.getElementById(e);return n.setAttribute("position",JSON.stringify(t)),document.addEventListener("touchstart",(t=>{t.target.closest(e)||n.remove()}),{once:!0}),n}function J(){const t=document.getElementById("translate-button");t&&t.remove()}function q(){const t="toast-progress",e=document.getElementById(t);return e&&e.remove(),document.body.insertAdjacentHTML("beforeend",`<toast-progress id="${t}"></toast-progress>`),document.getElementById(t)}function X(){const t="toast-error",e=document.getElementById(t);return e&&e.remove(),document.body.insertAdjacentHTML("beforeend",`<toast-error id="${t}"></toast-error>`),document.getElementById(t)}function F(t){const e="translate-popover";{const t=document.getElementById(e);t&&t.remove()}document.body.insertAdjacentHTML("beforeend",`<translate-popover id="${e}"></translate-popover>`);const n=document.getElementById(e);n.setAttribute("position",JSON.stringify(t)),browser.storage.local.get(["selectedTargetLanguage"],(t=>{t&&t.selectedTargetLanguage&&n.setAttribute("lang",t.selectedTargetLanguage)}));const s=t=>{t.target.closest(e)||(n.remove(),document.removeEventListener("click",s))};return document.addEventListener("click",s),n.addEventListener("close",(async()=>{n.remove(),document.removeEventListener("click",s)})),n.addEventListener("change",(async t=>{await browser.storage.local.set({selectedSourceLanguage:void 0,selectedTargetLanguage:t.detail.selectedTargetLanguage})})),n}function Y(){return document.getElementById("translate-popover")}function G(){const t=d(this,x,Y).call(this);if(t){const e=t.shadowRoot.querySelector("#draggable");if(e)return{x:e.offsetLeft,y:e.offsetTop}}}async function z(e){const n=document.querySelectorAll('[data-wtdl-translated="false"]');if(r(this,h)===e.targetLanguage)for(const t of n){const e=t.dataset.wtdlUid,n=r(this,m)[e];t.innerHTML=n,t.dataset.wtdlTranslated="true"}const s=await async function(){const e=[];et(document.body.children,e);const n=[];for(const s of e){!t(s)||void 0!==s.dataset.wtdlUid&&"false"!==s.dataset.wtdlTranslated||n.push({element:s,text:s.innerHTML})}return n}();if(0===s.length)return void d(this,B,Q).call(this);d(this,_,K).call(this);const a=s.map((t=>t.text)),o=await browser.runtime.sendMessage({method:"translate",texts:a,sourceLanguage:e.sourceLanguage,targetLanguage:e.targetLanguage}),i=t=>{const e=t||browser.i18n.getMessage("error_message_generic_error");d(this,R,Z).call(this,e)};if(!o||!o.result)return void i();const c=o.result.result;if(c&&c.texts){{l(this,g,c.lang),l(this,h,e.targetLanguage);const t=c.texts;if(t.length===s.length){for(let e=0;e<s.length;e++){var f,b;const n=s[e].element,a=t[e].text,o=n.dataset.wtdlUid||(l(this,u,(f=r(this,u),b=f++,f)),b);"true"!==n.dataset.wtdlOriginal&&(r(this,w)[o]=n.innerHTML),r(this,m)[o]=a,n.innerHTML=a,n.dataset.wtdlUid=`${o}`,n.dataset.wtdlOriginal="true",n.dataset.wtdlTranslated="true"}d(this,L,V).call(this)}}d(this,H,tt).call(this)}else{if(o.result.error){return void i(1045601===o.result.error.code?browser.i18n.getMessage("error_message_quota_has_been_reached"):o.result.error.message)}i()}}function K(){r(this,f).setAttribute("show",!0),l(this,v,!0),l(this,T,!1),browser.runtime.sendMessage({method:"startTranslation"})}function Q(){l(this,T,!1),browser.runtime.sendMessage({method:"cancelTranslation",result:{sourceLanguage:r(this,g),targetLanguage:r(this,h)}})}function Z(t){l(this,v,!1),l(this,T,!1),r(this,f).setAttribute("show",!1),r(this,b).setAttribute("show",t),browser.runtime.sendMessage({method:"abortTranslation",message:t})}function tt(){l(this,v,!1),r(this,f).setAttribute("show",!1),browser.runtime.sendMessage({method:"finishTranslation",result:{sourceLanguage:r(this,g),targetLanguage:r(this,h)}})}function et(t,a){for(const o of t){if(e(o))continue;if("NOSCRIPT"===o.nodeName||"svg"===o.nodeName)continue;const t=o.children,i=Array.from(o.childNodes).filter((t=>t.nodeType!==Node.COMMENT_NODE&&(t.nodeType!==Node.TEXT_NODE||t.nodeValue&&t.nodeValue.trim())));n(o)?1===i.length&&t.length>0?et(t,a):a.push(o):s(o)?1===i.length&&t.length>0?et(t,a):a.push(o):0!==t.length&&et(t,a)}}new class{constructor(){a(this,H),a(this,R),a(this,B),a(this,_),a(this,O),a(this,C),a(this,x),a(this,I),a(this,W),a(this,A),a(this,N),a(this,M),a(this,k),a(this,E),a(this,L),a(this,S),a(this,y),o(this,u,{writable:!0,value:1}),o(this,g,{writable:!0,value:void 0}),o(this,h,{writable:!0,value:void 0}),o(this,w,{writable:!0,value:{}}),o(this,m,{writable:!0,value:{}}),o(this,f,{writable:!0,value:void 0}),o(this,b,{writable:!0,value:void 0}),o(this,v,{writable:!0,value:!1}),o(this,p,{writable:!0,value:!1}),o(this,T,{writable:!0,value:!1}),d(this,y,P).call(this)}}})();
//# sourceMappingURL=content.js.map