(()=>{"use strict";function t(t){const e=t.getBoundingClientRect();return e.top<=window.innerHeight&&e.left<=window.innerWidth}function e(t){return"none"===getComputedStyle(t).display||!t.textContent||""===t.textContent.trim()}function n(t){const e=t.childNodes;if(0===e.length)return!1;for(const t of e)if(t.nodeType===Node.TEXT_NODE&&""!==t.nodeValue.trim())return!0;return!1}function s(t){const e=t.children;return!(!e||0===e.length)&&Array.from(e).every((t=>{const e=getComputedStyle(t).display;return t.textContent&&""!==t.textContent.trim()&&"BASE"!==t.tagName&&"LINK"!==t.tagName&&"NOSCRIPT"!==t.tagName&&"SCRIPT"!==t.tagName&&"STYLE"!==t.tagName&&"TEMPLATE"!==t.tagName&&"TITLE"!==t.tagName&&"AUDIO"!==t.tagName&&"CANVAS"!==t.tagName&&"IMG"!==t.tagName&&"MATH"!==t.tagName&&"OBJECT"!==t.tagName&&"PICTURE"!==t.tagName&&"SVG"!==t.tagName&&"VIDEO"!==t.tagName&&"block"!==e&&"none"!==e}))}function a(t,e){r(t,e),e.add(t)}function i(t,e,n){r(t,e),e.set(t,n)}function r(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function o(t,e){return function(t,e){if(e.get)return e.get.call(t);return e.value}(t,c(t,e,"get"))}function l(t,e,n){return function(t,e,n){if(e.set)e.set.call(t,n);else{if(!e.writable)throw new TypeError("attempted to set read only private field");e.value=n}}(t,c(t,e,"set"),n),n}function c(t,e,n){if(!e.has(t))throw new TypeError("attempted to "+n+" private field on non-instance");return e.get(t)}function d(t,e,n){if(!e.has(t))throw new TypeError("attempted to get private field on non-instance");return n}var u=new WeakMap,g=new WeakMap,h=new WeakMap,w=new WeakMap,m=new WeakMap,f=new WeakMap,b=new WeakMap,v=new WeakMap,p=new WeakMap,T=new WeakMap,y=new WeakSet,L=new WeakSet,S=new WeakSet,k=new WeakSet,E=new WeakSet,M=new WeakSet,A=new WeakSet,W=new WeakSet,N=new WeakSet,x=new WeakSet,I=new WeakSet,C=new WeakSet,O=new WeakSet,_=new WeakSet,B=new WeakSet,H=new WeakSet,R=new WeakSet;function j(){d(this,L,P).call(this);const t=d(this,I,G).call(this);t&&t.remove();const e=document.getElementById("translate-button");e&&e.remove(),l(this,f,d(this,W,q).call(this)),l(this,b,d(this,N,X).call(this)),d(this,k,U).call(this),("ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0)&&d(this,E,D).call(this)}function P(){const t="__wtdl-global-data",e=document.getElementById(t);if(e){if(e.dataset.wtdlOriginalTexts)try{l(this,w,JSON.parse(e.dataset.wtdlOriginalTexts))}catch(t){}}else document.body.insertAdjacentHTML("beforeend",`<div id="${t}" style="display: none;"></div>`)}function $(){const t=document.getElementById("__wtdl-global-data");t&&(t.dataset.wtdlOriginalTexts=JSON.stringify(o(this,w)))}function U(){browser.runtime.onMessage.addListener((async(t,e,n)=>{if(t)switch(t.method){case"translate":l(this,p,!0),await d(this,O,K).call(this,t),function(t,e){let n;return function(){return t&&(n=t.apply(e||this,arguments),t=void 0),n}}(function(t){let e,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:200;window.addEventListener("scroll",(function(s){window.clearTimeout(e),e=setTimeout(t,n)}),{once:!1,passive:!0,capture:!0})}((async()=>{o(this,p)&&await d(this,O,K).call(this,{sourceLanguage:o(this,g),targetLanguage:o(this,h)})}),500))(),n();break;case"getContentState":o(this,v)?n({result:{isProcessing:o(this,v)}}):Object.keys(o(this,w)).length>0?n({result:{sourceLanguage:o(this,g),targetLanguage:o(this,h),isShowingOriginal:o(this,T)}}):n(void 0);break;case"showOriginal":{l(this,p,!1),l(this,T,!0);const t=document.querySelectorAll('[data-wtdl-translated="true"]');for(const e of t){const t=e.dataset.wtdlUid,n=o(this,w)[t];void 0!==n&&(e.innerHTML=n,e.dataset.wtdlTranslated="false")}n();break}case"startTranslateSelection":{const t=window.getSelection().getRangeAt(0).getBoundingClientRect(),e=t.left+window.scrollX,s=t.bottom+window.scrollY+30,a=d(this,C,z).call(this);d(this,x,Y).call(this,a||{x:e,y:s}).setAttribute("loading",!0),n();break}case"finishTranslateSelection":{const e=t.result,s=d(this,I,G).call(this);if(s){if(e.result&&e.result.texts){const n=e.result.texts.map((t=>t.text)).join("\n");s.setAttribute("result",`${n}`),s.setAttribute("lang",`${t.targetLanguage||""}`)}else if(e.error){const t=browser.i18n.getMessage("error_message_generic_error");s.setAttribute("error",t)}else{const t=browser.i18n.getMessage("error_message_generic_error");s.setAttribute("error",t)}s.setAttribute("loading",!1)}n();break}case"getSelection":{const t=window.getSelection();n({result:t?t.toString():void 0});break}default:n()}})),browser.storage.onChanged.addListener(((t,e)=>{if("local"===e&&"selectedTargetLanguage"in t){const e=d(this,I,G).call(this);e&&(e.setAttribute("lang",t.selectedTargetLanguage.newValue),browser.runtime.sendMessage({method:"translateSelection",selectionText:void 0}))}}))}function D(){document.addEventListener("pointerup",(async t=>{t.preventDefault();const e=window.getSelection(),n=e?e.toString().trim():"";n||e.rangeCount?setTimeout((()=>{const t=e.getRangeAt(0).cloneRange();t.collapse(e.anchorOffset>e.focusOffset);const s=t.getBoundingClientRect(),a=s.right+window.scrollX-20,i=s.bottom+window.scrollY+40;{const t=window.getSelection();if(!t||!t.toString().trim())return void d(this,A,V).call(this)}const r=d(this,M,J).call(this,{x:a,y:i});r.addEventListener("tooltipClick",(t=>(t.preventDefault(),t.stopPropagation(),n&&browser.runtime.sendMessage({method:"translateSelection",selectionText:n}),r.remove(),!1)))}),100):d(this,A,V).call(this)}))}function J(t){const e="translate-button";{const t=document.getElementById(e);t&&t.remove()}document.body.insertAdjacentHTML("beforeend",`<translate-button id="${e}"></translate-button>`);const n=document.getElementById(e);return n.setAttribute("position",JSON.stringify(t)),document.addEventListener("touchstart",(t=>{t.target.closest(e)||n.remove()}),{once:!0}),n}function V(){const t=document.getElementById("translate-button");t&&t.remove()}function q(){const t="toast-progress",e=document.getElementById(t);return e&&e.remove(),document.body.insertAdjacentHTML("beforeend",`<toast-progress id="${t}"></toast-progress>`),document.getElementById(t)}function X(){const t="toast-error",e=document.getElementById(t);return e&&e.remove(),document.body.insertAdjacentHTML("beforeend",`<toast-error id="${t}"></toast-error>`),document.getElementById(t)}function Y(t){const e="translate-popover";{const t=document.getElementById(e);t&&t.remove()}document.body.insertAdjacentHTML("beforeend",`<translate-popover id="${e}"></translate-popover>`);const n=document.getElementById(e);n.setAttribute("position",JSON.stringify(t)),browser.storage.local.get(["selectedTargetLanguage"],(t=>{t&&t.selectedTargetLanguage&&n.setAttribute("lang",t.selectedTargetLanguage)}));const s=t=>{t.target.closest(e)||(n.remove(),document.removeEventListener("click",s))};return document.addEventListener("click",s),n.addEventListener("close",(async()=>{n.remove(),document.removeEventListener("click",s)})),n.addEventListener("change",(async t=>{await browser.storage.local.set({selectedSourceLanguage:void 0,selectedTargetLanguage:t.detail.selectedTargetLanguage})})),n}function G(){return document.getElementById("translate-popover")}function z(){const t=d(this,I,G).call(this);if(t){const e=t.shadowRoot.querySelector("#draggable");if(e)return{x:e.offsetLeft,y:e.offsetTop}}}async function K(e){const n=document.querySelectorAll('[data-wtdl-translated="false"]');if(o(this,h)===e.targetLanguage)for(const t of n){const e=t.dataset.wtdlUid,n=o(this,m)[e];t.innerHTML=n,t.dataset.wtdlTranslated="true"}const s=await async function(){const e=[];et(document.body.children,e);const n=[];for(const s of e){!t(s)||void 0!==s.dataset.wtdlUid&&"false"!==s.dataset.wtdlTranslated||n.push({element:s,text:s.innerHTML})}return n}();if(0===s.length)return void d(this,B,Q).call(this);d(this,_,F).call(this);const a=s.map((t=>t.text)),i=await browser.runtime.sendMessage({method:"translate",texts:a,sourceLanguage:e.sourceLanguage,targetLanguage:e.targetLanguage});if(i&&i.result){const t=i.result.result;if(t&&t.texts){l(this,g,t.lang),l(this,h,e.targetLanguage);const n=t.texts;if(n.length===s.length){for(let t=0;t<s.length;t++){var r,c;const e=s[t].element,a=n[t].text,i=e.dataset.wtdlUid||(l(this,u,(r=o(this,u),c=r++,r)),c);"true"!==e.dataset.wtdlOriginal&&(o(this,w)[i]=e.innerHTML),o(this,m)[i]=a,e.innerHTML=a,e.dataset.wtdlUid=`${i}`,e.dataset.wtdlOriginal="true",e.dataset.wtdlTranslated="true"}d(this,S,$).call(this)}}else if(i.result.error){const t=1045601===i.result.error.code?browser.i18n.getMessage("error_message_quota_has_been_reached"):i.result.error.message||browser.i18n.getMessage("error_message_generic_error");return void d(this,H,Z).call(this,t)}}d(this,R,tt).call(this)}function F(){o(this,f).setAttribute("show",!0),l(this,v,!0),l(this,T,!1),browser.runtime.sendMessage({method:"startTranslation"})}function Q(){l(this,T,!1),browser.runtime.sendMessage({method:"cancelTranslation",result:{sourceLanguage:o(this,g),targetLanguage:o(this,h)}})}function Z(t){l(this,v,!1),l(this,T,!1),o(this,f).setAttribute("show",!1),o(this,b).setAttribute("show",t),browser.runtime.sendMessage({method:"abortTranslation",message:t})}function tt(){l(this,v,!1),o(this,f).setAttribute("show",!1),browser.runtime.sendMessage({method:"finishTranslation",result:{sourceLanguage:o(this,g),targetLanguage:o(this,h)}})}function et(t,a){for(const i of t){if(e(i))continue;if("svg"===i.nodeName)continue;if(n(i)){a.push(i);continue}if(s(i)){a.push(i);continue}const t=i.children;t&&0!==t.length&&et(i.children,a)}}new class{constructor(){a(this,R),a(this,H),a(this,B),a(this,_),a(this,O),a(this,C),a(this,I),a(this,x),a(this,N),a(this,W),a(this,A),a(this,M),a(this,E),a(this,k),a(this,S),a(this,L),a(this,y),i(this,u,{writable:!0,value:1}),i(this,g,{writable:!0,value:void 0}),i(this,h,{writable:!0,value:void 0}),i(this,w,{writable:!0,value:{}}),i(this,m,{writable:!0,value:{}}),i(this,f,{writable:!0,value:void 0}),i(this,b,{writable:!0,value:void 0}),i(this,v,{writable:!0,value:!1}),i(this,p,{writable:!0,value:!1}),i(this,T,{writable:!0,value:!1}),d(this,y,j).call(this)}}})();
//# sourceMappingURL=content.js.map