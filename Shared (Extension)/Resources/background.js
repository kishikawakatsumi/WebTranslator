(()=>{"use strict";class e{#e=1e4*Math.round(1e4*Math.random());#t;#s;constructor(){}setSourceLanguage(e){this.#t=e}setTargetLanguage(e){this.#s=e}async translate(e,t=!0){this.#e++;let s=1;for(const t of e)for(let e=0;e<t.length;e++)"i"===t[e]&&s++;let a=Date.now();a=a-a%s+s;let n=JSON.stringify({jsonrpc:"2.0",method:"LMT_handle_texts",params:{texts:e.map((e=>({text:e}))),html:t?"enabled":void 0,splitting:t?void 0:"newlines",lang:{target_lang:this.#s,source_lang_user_selected:this.#t||"auto"},timestamp:a},id:this.#e});n=n.replace('"method":"',""+((this.#e+3)%13==0||(this.#e+5)%29==0?'"method" : "':'"method": "'));const r={method:t?"translate":"translateSelection",payload:{headers:{Accept:"*/*","x-app-os-name":"iOS","Accept-Encoding":"gzip, deflate, br","Content-Type":"application/json",Referer:"https://www.deepl.com/"},method:"POST",body:n}};return new Promise((e=>{browser.runtime.sendNativeMessage("application.id",r,(t=>{t&&t.result?e(t.result):e(void 0)}))}))}}new class{#a=void 0;#n=void 0;constructor(){this.#r(),this.#i()}#r(){this.#o(),this.#l(),this.#c()}#o(){browser.runtime.onMessage.addListener((async(e,s,a)=>{if(e&&"getLoginSession"===e.method)a({result:this.#a});else if(e&&"translate"===e.method){const s=e.texts;a({result:await t(s,e.sourceLanguage,e.targetLanguage)})}else if(e&&"translateSelection"===e.method){const e=this.#n;e&&e.trim()&&this.#g(e),a({result})}else a()}))}#l(){browser.alarms.create("getUserDisplayName",{periodInMinutes:60}),browser.alarms.onAlarm.addListener((e=>{"getUserDisplayName"===e.name&&this.#i()}))}#c(){browser.menus.create&&(browser.menus.create({id:"translateSelection",title:browser.i18n.getMessage("context_menus_translate_section"),contexts:["editable","link","page","selection"]}),browser.menus.onClicked.addListener((async(e,t)=>{if("translateSelection"===e.menuItemId){const t=e.selectionText;t&&t.trim()&&this.#g(t)}})))}#i(){browser.runtime.sendNativeMessage("application.id",{method:"getUserDisplayName"},(e=>{e&&e.result?this.#a=e.result:this.#a=void 0}))}async#g(e){this.#n=e,browser.tabs.query({active:!0,currentWindow:!0},(t=>{browser.tabs.sendMessage(t[0].id,{method:"startTranslateSelection",selectionText:e})}));const s=await t([e],void 0,await async function(){return new Promise(((e,t)=>{browser.storage.local.get(["selectedTargetLanguage"],(t=>{if(t&&t.selectedTargetLanguage)e(t.selectedTargetLanguage);else{const t=browser.i18n.getUILanguage().split("-").shift().toUpperCase();e(t)}}))}))}(),!1);browser.tabs.query({active:!0,currentWindow:!0},(e=>{browser.tabs.sendMessage(e[0].id,{method:"finishTranslateSelection",result:s})}))}};async function t(t,s,a,n=!0){const r=new e;r.setSourceLanguage(s),r.setTargetLanguage(a);return await r.translate(t,n)}})();