{"version":3,"file":"background.js","mappings":"mBAEO,MAAMA,EAAqB,CAChC,CACEC,KAAM,KACNC,KAAM,aAER,CACED,KAAM,KACNC,KAAM,wBAER,CACED,KAAM,KACNC,KAAM,SAER,CACED,KAAM,KACNC,KAAM,UAER,CACED,KAAM,KACNC,KAAM,SAER,CACED,KAAM,KACNC,KAAM,WAER,CACED,KAAM,KACNC,KAAM,YAER,CACED,KAAM,KACNC,KAAM,WAER,CACED,KAAM,KACNC,KAAM,UAER,CACED,KAAM,KACNC,KAAM,UAER,CACED,KAAM,KACNC,KAAM,SAER,CACED,KAAM,KACNC,KAAM,aAER,CACED,KAAM,KACNC,KAAM,cAER,CACED,KAAM,KACNC,KAAM,WAER,CACED,KAAM,KACNC,KAAM,YAER,CACED,KAAM,KACNC,KAAM,UAER,CACED,KAAM,KACNC,KAAM,WAER,CACED,KAAM,KACNC,KAAM,cAER,CACED,KAAM,KACNC,KAAM,aAER,CACED,KAAM,KACNC,KAAM,UAER,CACED,KAAM,KACNC,KAAM,cAER,CACED,KAAM,KACNC,KAAM,YAER,CACED,KAAM,KACNC,KAAM,WAER,CACED,KAAM,KACNC,KAAM,UAER,CACED,KAAM,KACNC,KAAM,aAER,CACED,KAAM,KACNC,KAAM,WAER,CACED,KAAM,KACNC,KAAM,WAER,CACED,KAAM,KACNC,KAAM,WAER,CACED,KAAM,KACNC,KAAM,cCrHG,SAAAC,EAAAC,EAAAC,EAAAC,IAAA,SAAAF,EAAAG,GAAA,GAAAA,EAAAC,IAAAJ,GAAA,UAAAK,UAAA,kEAAAC,CAAAN,EAAAC,GAAAA,EAAAM,IAAAP,EAAAE,EAAA,UAAAM,EAAAC,EAAAR,GAAA,gBAAAQ,EAAAC,GAAA,GAAAA,EAAAC,IAAA,OAAAD,EAAAC,IAAAC,KAAAH,GAAA,OAAAC,EAAAR,KAAA,CAAAW,CAAAJ,EAAAK,EAAAL,EAAAR,EAAA,iBAAAc,EAAAN,EAAAR,EAAAC,GAAA,gBAAAO,EAAAC,EAAAR,GAAA,GAAAQ,EAAAH,IAAAG,EAAAH,IAAAK,KAAAH,EAAAP,OAAA,KAAAQ,EAAAM,SAAA,UAAAX,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","sources":["webpack://webtranslator/./src/shared/supported_languages.js","webpack://webtranslator/./src/background/translator.js","webpack://webtranslator/./src/background/background.js"],"sourcesContent":["\"use strict\";\n\nexport const supportedLanguages = [\n  {\n    code: \"BG\",\n    name: \"Bulgarian\",\n  },\n  {\n    code: \"ZH\",\n    name: \"Chinese (simplified)\",\n  },\n  {\n    code: \"CS\",\n    name: \"Czech\",\n  },\n  {\n    code: \"DA\",\n    name: \"Danish\",\n  },\n  {\n    code: \"NL\",\n    name: \"Dutch\",\n  },\n  {\n    code: \"EN\",\n    name: \"English\",\n  },\n  {\n    code: \"ET\",\n    name: \"Estonian\",\n  },\n  {\n    code: \"FI\",\n    name: \"Finnish\",\n  },\n  {\n    code: \"FR\",\n    name: \"French\",\n  },\n  {\n    code: \"DE\",\n    name: \"German\",\n  },\n  {\n    code: \"EL\",\n    name: \"Greek\",\n  },\n  {\n    code: \"HU\",\n    name: \"Hungarian\",\n  },\n  {\n    code: \"ID\",\n    name: \"Indonesian\",\n  },\n  {\n    code: \"IT\",\n    name: \"Italian\",\n  },\n  {\n    code: \"JA\",\n    name: \"Japanese\",\n  },\n  {\n    code: \"KO\",\n    name: \"Korean\",\n  },\n  {\n    code: \"LV\",\n    name: \"Latvian\",\n  },\n  {\n    code: \"LT\",\n    name: \"Lithuanian\",\n  },\n  {\n    code: \"NB\",\n    name: \"Norwegian\",\n  },\n  {\n    code: \"PL\",\n    name: \"Polish\",\n  },\n  {\n    code: \"PT\",\n    name: \"Portuguese\",\n  },\n  {\n    code: \"RO\",\n    name: \"Romanian\",\n  },\n  {\n    code: \"RU\",\n    name: \"Russian\",\n  },\n  {\n    code: \"SK\",\n    name: \"Slovak\",\n  },\n  {\n    code: \"SL\",\n    name: \"Slovenian\",\n  },\n  {\n    code: \"ES\",\n    name: \"Spanish\",\n  },\n  {\n    code: \"SV\",\n    name: \"Swedish\",\n  },\n  {\n    code: \"TR\",\n    name: \"Turkish\",\n  },\n  {\n    code: \"UK\",\n    name: \"Ukrainian\",\n  },\n];\n","\"use strict\";\n\nimport { supportedLanguages } from \"../shared/supported_languages\";\n\nexport class Translator {\n  #id = 1e4 * Math.round(1e4 * Math.random());\n\n  #sourceLanguage;\n  #targetLanguage;\n\n  constructor() {}\n\n  setSourceLanguage(sourceLanguage) {\n    this.#sourceLanguage = sourceLanguage;\n  }\n\n  setTargetLanguage(targetLanguage) {\n    this.#targetLanguage = targetLanguage;\n  }\n\n  async translate(texts, isHtmlEnabled = true) {\n    this.#id++;\n\n    let n = 1;\n    for (const text of texts) {\n      for (let i = 0; i < text.length; i++) {\n        if (text[i] === \"i\") {\n          n++;\n        }\n      }\n    }\n\n    let timestamp = Date.now();\n    timestamp = timestamp - (timestamp % n) + n;\n\n    let body = JSON.stringify({\n      jsonrpc: \"2.0\",\n      method: \"LMT_handle_texts\",\n      params: {\n        texts: texts.map((text) => {\n          return {\n            text,\n          };\n        }),\n        html: isHtmlEnabled ? \"enabled\" : undefined,\n        splitting: isHtmlEnabled ? undefined : \"newlines\",\n        lang: {\n          target_lang: isValidLanguage(this.#targetLanguage)\n            ? this.#targetLanguage\n            : supportedLanguages[0].code,\n          source_lang_user_selected: this.#sourceLanguage || \"auto\",\n        },\n        timestamp,\n      },\n      id: this.#id,\n    });\n    body = body.replace(\n      `\"method\":\"`,\n      `${\n        (this.#id + 3) % 13 === 0 || (this.#id + 5) % 29 === 0\n          ? `\"method\" : \"`\n          : `\"method\": \"`\n      }`\n    );\n\n    const request = {\n      method: isHtmlEnabled ? \"translate\" : \"translateSelection\",\n      payload: {\n        headers: {\n          Accept: \"*/*\",\n          \"x-app-os-name\": \"iOS\",\n          \"Accept-Encoding\": \"gzip, deflate, br\",\n          \"Content-Type\": \"application/json\",\n          Referer: \"https://www.deepl.com/\",\n        },\n        method: \"POST\",\n        body: body,\n      },\n    };\n\n    return new Promise((resolve) => {\n      browser.runtime.sendNativeMessage(\n        \"application.id\",\n        request,\n        (response) => {\n          if (response && response.result) {\n            resolve(response.result);\n          } else {\n            resolve(undefined);\n          }\n        }\n      );\n    });\n  }\n}\n\nfunction isValidLanguage(language) {\n  return supportedLanguages.some((supportedLanguage) => {\n    return supportedLanguage.code === language;\n  });\n}\n","\"use strict\";\n\nimport { Translator } from \"./translator\";\n\nclass App {\n  #selectionText = undefined;\n\n  constructor() {\n    this.#init();\n  }\n\n  #init() {\n    this.#setupListeners();\n    this.#setupContextMenu();\n  }\n\n  #setupListeners() {\n    browser.runtime.onMessage.addListener((request, sender, sendResponse) => {\n      if (!request) {\n        return;\n      }\n      switch (request.method) {\n        case \"translate\": {\n          const texts = request.texts;\n          translate(texts, request.sourceLanguage, request.targetLanguage)\n            .then((result) => {\n              sendResponse({ result });\n            })\n            .catch((error) => {\n              sendResponse();\n            });\n          break;\n        }\n        case \"translateSelection\": {\n          const selectionText = this.#selectionText;\n          if (request.selectionText && request.selectionText.trim()) {\n            // From popup toolbar (Mobile only)\n            this.#translateSelection(request.selectionText);\n          } else if (selectionText && selectionText.trim()) {\n            // Language changed in popover window\n            this.#translateSelection(selectionText);\n          }\n\n          sendResponse();\n          break;\n        }\n        default: {\n          sendResponse();\n          break;\n        }\n      }\n\n      return true;\n    });\n\n    browser.commands.onCommand.addListener((command) => {\n      if (command === \"trigger-translation\") {\n        browser.storage.local.get([\"settingsReadingShortcut\"], (result) => {\n          const settingsReadingShortcut =\n            result.settingsReadingShortcut === undefined ||\n            result.settingsReadingShortcut;\n          if (settingsReadingShortcut) {\n            browser.tabs\n              .executeScript({\n                code: `window.getSelection().toString();`,\n              })\n              .then((selection) => {\n                if (selection) {\n                  const selectionText = selection.toString().trim();\n                  if (selectionText) {\n                    this.#translateSelection(selectionText);\n                  }\n                }\n              });\n          }\n        });\n      }\n    });\n  }\n\n  #setupContextMenu() {\n    if (browser.menus.create) {\n      browser.menus.create({\n        id: \"translateSelection\",\n        title: browser.i18n.getMessage(\"context_menus_translate_section\"),\n        contexts: [\"editable\", \"link\", \"page\", \"selection\"],\n      });\n\n      browser.menus.onClicked.addListener(async (info, tab) => {\n        switch (info.menuItemId) {\n          case \"translateSelection\":\n            const selectionText = info.selectionText;\n            if (selectionText && selectionText.trim()) {\n              this.#translateSelection(selectionText);\n            }\n        }\n      });\n    }\n  }\n\n  async #translateSelection(selectionText) {\n    this.#selectionText = selectionText;\n    const targetLanguage = await getTargetLanguage();\n\n    browser.tabs.query({ active: true, currentWindow: true }, (tabs) => {\n      browser.tabs.sendMessage(tabs[0].id, {\n        method: \"startTranslateSelection\",\n        selectionText,\n      });\n    });\n\n    const result = await translate(\n      [selectionText],\n      undefined,\n      targetLanguage,\n      false\n    );\n\n    browser.tabs.query({ active: true, currentWindow: true }, (tabs) => {\n      browser.tabs.sendMessage(tabs[0].id, {\n        method: \"finishTranslateSelection\",\n        result,\n        targetLanguage,\n      });\n    });\n    browser.runtime.sendMessage({\n      method: \"finishTranslateSelection\",\n    });\n  }\n}\n\nasync function translate(\n  texts,\n  sourceLanguage,\n  targetLanguage,\n  isHtmlEnabled = true\n) {\n  const translator = new Translator();\n  translator.setSourceLanguage(sourceLanguage);\n  translator.setTargetLanguage(targetLanguage);\n\n  const result = await translator.translate(texts, isHtmlEnabled);\n  return result;\n}\n\nasync function getTargetLanguage() {\n  return new Promise((resolve, reject) => {\n    browser.storage.local.get([\"selectedTargetLanguage\"], (result) => {\n      if (result && result.selectedTargetLanguage) {\n        resolve(result.selectedTargetLanguage);\n      } else {\n        const locale = browser.i18n\n          .getUILanguage()\n          .split(\"-\")\n          .shift()\n          .toUpperCase();\n        resolve(locale);\n      }\n    });\n  });\n}\n\nnew App();\n"],"names":["supportedLanguages","code","name","_classPrivateFieldInitSpec","obj","privateMap","value","privateCollection","has","TypeError","_checkPrivateRedeclaration","set","_classPrivateFieldGet","receiver","descriptor","get","call","_classApplyDescriptorGet","_classExtractFieldDescriptor","_classPrivateFieldSet","writable","_classApplyDescriptorSet","action","_id","WeakMap","_sourceLanguage","_targetLanguage","Translator","constructor","Math","round","random","setSourceLanguage","sourceLanguage","this","setTargetLanguage","targetLanguage","async","texts","_this$id","isHtmlEnabled","arguments","length","undefined","n","text","i","timestamp","Date","now","body","JSON","stringify","jsonrpc","method","params","map","html","splitting","lang","target_lang","language","some","supportedLanguage","source_lang_user_selected","id","replace","request","payload","headers","Accept","Referer","Promise","resolve","browser","runtime","sendNativeMessage","response","result","_classPrivateMethodInitSpec","privateSet","add","_classPrivateMethodGet","fn","_selectionText","_init","WeakSet","_setupListeners","_setupContextMenu","_translateSelection","_init2","_setupListeners2","_setupContextMenu2","onMessage","addListener","sender","sendResponse","translate","then","catch","error","selectionText","trim","_translateSelection2","commands","onCommand","command","storage","local","settingsReadingShortcut","tabs","executeScript","selection","toString","menus","create","title","i18n","getMessage","contexts","onClicked","info","tab","menuItemId","reject","selectedTargetLanguage","locale","getUILanguage","split","shift","toUpperCase","getTargetLanguage","query","active","currentWindow","sendMessage","translator"],"sourceRoot":""}