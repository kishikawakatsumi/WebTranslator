{"version":3,"file":"content.js","mappings":"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","sources":["webpack://webtranslator/./src/content/utils.js","webpack://webtranslator/./src/content/content.js"],"sourcesContent":["\"use strict\";\n\nexport function isVisible(element) {\n  const rect = element.getBoundingClientRect();\n  return rect.top <= window.innerHeight && rect.left <= window.innerWidth;\n}\n\nexport function isHidden(element) {\n  return (\n    getComputedStyle(element).display === \"none\" ||\n    !element.textContent ||\n    element.textContent.trim() === \"\"\n  );\n}\n\nexport function hasTextNode(element) {\n  const childNodes = element.childNodes;\n  if (childNodes.length === 0) {\n    return false;\n  }\n  for (const child of childNodes) {\n    if (child.nodeType === Node.TEXT_NODE && child.nodeValue.trim() !== \"\") {\n      return true;\n    }\n  }\n  return false;\n}\n\nexport function hasNoBlockElement(element) {\n  const children = element.children;\n  if (!children || children.length === 0) {\n    return false;\n  }\n  return Array.from(children).every((child) => {\n    const display = getComputedStyle(child).display;\n    return (\n      child.textContent &&\n      child.textContent.trim() !== \"\" &&\n      child.tagName !== \"BASE\" &&\n      child.tagName !== \"LINK\" &&\n      child.tagName !== \"NOSCRIPT\" &&\n      child.tagName !== \"SCRIPT\" &&\n      child.tagName !== \"STYLE\" &&\n      child.tagName !== \"TEMPLATE\" &&\n      child.tagName !== \"TITLE\" &&\n      child.tagName !== \"AUDIO\" &&\n      child.tagName !== \"CANVAS\" &&\n      child.tagName !== \"IMG\" &&\n      child.tagName !== \"MATH\" &&\n      child.tagName !== \"OBJECT\" &&\n      child.tagName !== \"PICTURE\" &&\n      child.tagName !== \"SVG\" &&\n      child.tagName !== \"VIDEO\" &&\n      display !== \"block\" &&\n      display !== \"none\"\n    );\n  });\n}\n\nexport function scrollDidStop(callback, refresh = 200) {\n  let isScrolling;\n  window.addEventListener(\n    \"scroll\",\n    function (event) {\n      window.clearTimeout(isScrolling);\n      isScrolling = setTimeout(callback, refresh);\n    },\n    {\n      once: false,\n      passive: true,\n      capture: true,\n    }\n  );\n}\n\nexport function once(fn, context) {\n  let result;\n  return function () {\n    if (fn) {\n      result = fn.apply(context || this, arguments);\n      fn = undefined;\n    }\n    return result;\n  };\n}\n\nexport function escapeHTML(text) {\n  const div = document.createElement(\"div\");\n  div.textContent = text;\n  return div.innerHTML;\n}\n\nexport function isTouchDevice() {\n  return (\n    \"ontouchstart\" in window ||\n    navigator.maxTouchPoints > 0 ||\n    navigator.msMaxTouchPoints > 0\n  );\n}\n","\"use strict\";\n\nimport {\n  isVisible,\n  isHidden,\n  hasTextNode,\n  hasNoBlockElement,\n  once,\n  scrollDidStop,\n  isTouchDevice,\n} from \"./utils\";\n\nclass App {\n  #uid = 1;\n  #sourceLanguage = undefined;\n  #targetLanguage = undefined;\n  #originalTexts = {};\n  #translatedTexts = {};\n\n  #toastProgress = undefined;\n  #toastError = undefined;\n\n  #isProcessing = false;\n  #shouldProcessAfterScrolling = false;\n  #isShowingOriginal = false;\n\n  constructor() {\n    this.#init();\n  }\n\n  #init() {\n    this.#restoreState();\n\n    const popover = this.#getPopover();\n    if (popover) {\n      popover.remove();\n    }\n    const tooltip = document.getElementById(\"translate-button\");\n    if (tooltip) {\n      tooltip.remove();\n    }\n\n    this.#toastProgress = this.#createToastProgress();\n    this.#toastError = this.#createToastError();\n\n    this.#setupListeners();\n    if (isTouchDevice()) {\n      this.#observeTextSelection();\n    }\n  }\n\n  #restoreState() {\n    const id = \"__wtdl-global-data\";\n    const global = document.getElementById(id);\n    if (global) {\n      if (global.dataset.wtdlOriginalTexts) {\n        try {\n          this.#originalTexts = JSON.parse(global.dataset.wtdlOriginalTexts);\n        } catch (error) {}\n      }\n      return;\n    }\n    document.body.insertAdjacentHTML(\n      \"beforeend\",\n      `<div id=\"${id}\" style=\"display: none;\"></div>`\n    );\n  }\n\n  #saveState() {\n    const global = document.getElementById(\"__wtdl-global-data\");\n    if (global) {\n      global.dataset.wtdlOriginalTexts = JSON.stringify(this.#originalTexts);\n    }\n  }\n\n  #setupListeners() {\n    browser.runtime.onMessage.addListener(\n      async (request, sender, sendResponse) => {\n        if (!request) {\n          return;\n        }\n        switch (request.method) {\n          case \"translate\": {\n            this.#shouldProcessAfterScrolling = true;\n\n            await this.#translatePage(request);\n\n            once(\n              scrollDidStop(async () => {\n                if (this.#shouldProcessAfterScrolling) {\n                  await this.#translatePage({\n                    sourceLanguage: this.#sourceLanguage,\n                    targetLanguage: this.#targetLanguage,\n                  });\n                }\n              }, 500)\n            )();\n\n            sendResponse();\n            break;\n          }\n          case \"getContentState\": {\n            if (this.#isProcessing) {\n              sendResponse({ result: { isProcessing: this.#isProcessing } });\n            } else if (Object.keys(this.#originalTexts).length > 0) {\n              sendResponse({\n                result: {\n                  sourceLanguage: this.#sourceLanguage,\n                  targetLanguage: this.#targetLanguage,\n                  isShowingOriginal: this.#isShowingOriginal,\n                },\n              });\n            } else {\n              sendResponse(undefined);\n            }\n            break;\n          }\n          case \"showOriginal\": {\n            this.#shouldProcessAfterScrolling = false;\n            this.#isShowingOriginal = true;\n\n            const elements = document.querySelectorAll(\n              '[data-wtdl-translated=\"true\"]'\n            );\n            for (const element of elements) {\n              const uid = element.dataset.wtdlUid;\n              const originalText = this.#originalTexts[uid];\n              if (originalText === undefined) {\n                continue;\n              }\n              element.innerHTML = originalText;\n              element.dataset.wtdlTranslated = \"false\";\n            }\n            sendResponse();\n            break;\n          }\n          case \"startTranslateSelection\": {\n            const selection = window.getSelection();\n            const textRange = selection.getRangeAt(0);\n            const selectionRect = textRange.getBoundingClientRect();\n\n            const x = selectionRect.left + window.scrollX;\n            const y = selectionRect.bottom + window.scrollY + 30;\n\n            const position = this.#getExistingPopoverPosition();\n            const popover = this.#createPopover(position || { x, y });\n            popover.setAttribute(\"loading\", true);\n\n            sendResponse();\n            break;\n          }\n          case \"finishTranslateSelection\": {\n            const result = request.result;\n            const popover = this.#getPopover();\n            if (popover) {\n              if (result.result && result.result.texts) {\n                const text = result.result.texts.map((t) => t.text).join(\"\\n\");\n                popover.setAttribute(\"result\", `${text}`);\n                popover.setAttribute(\"lang\", `${request.targetLanguage || \"\"}`);\n              } else {\n                if (result.error) {\n                  const message = browser.i18n.getMessage(\n                    \"error_message_generic_error\"\n                  );\n                  popover.setAttribute(\"error\", message);\n                } else {\n                  const message = browser.i18n.getMessage(\n                    \"error_message_generic_error\"\n                  );\n                  popover.setAttribute(\"error\", message);\n                }\n              }\n              popover.setAttribute(\"loading\", false);\n            }\n            sendResponse();\n            break;\n          }\n          case \"getSelection\": {\n            const selection = window.getSelection();\n            sendResponse({\n              result: selection ? selection.toString() : undefined,\n            });\n            break;\n          }\n          default: {\n            sendResponse();\n            break;\n          }\n        }\n      }\n    );\n\n    browser.storage.onChanged.addListener((changes, areaName) => {\n      if (areaName === \"local\" && \"selectedTargetLanguage\" in changes) {\n        const popover = this.#getPopover();\n        if (popover) {\n          popover.setAttribute(\"lang\", changes.selectedTargetLanguage.newValue);\n          browser.runtime.sendMessage({\n            method: \"translateSelection\",\n            selectionText: undefined,\n          });\n        }\n      }\n    });\n  }\n\n  #observeTextSelection() {\n    document.addEventListener(\"pointerup\", async (event) => {\n      event.preventDefault();\n\n      const selection = window.getSelection();\n      const selectionText = selection ? selection.toString().trim() : \"\";\n      if (!selectionText && !selection.rangeCount) {\n        this.#removeTooltip();\n        return;\n      }\n\n      setTimeout(() => {\n        const textRange = selection.getRangeAt(0).cloneRange();\n        textRange.collapse(selection.anchorOffset > selection.focusOffset);\n        const selectionRect = textRange.getBoundingClientRect();\n\n        const x = selectionRect.right + window.scrollX - 20;\n        const y = selectionRect.bottom + window.scrollY + 40;\n\n        {\n          const selection = window.getSelection();\n          if (!selection || !selection.toString().trim()) {\n            this.#removeTooltip();\n            return;\n          }\n        }\n\n        const tooltip = this.#createTooltip({ x, y });\n        tooltip.addEventListener(\"tooltipClick\", (event) => {\n          event.preventDefault();\n          event.stopPropagation();\n\n          if (selectionText) {\n            browser.runtime.sendMessage({\n              method: \"translateSelection\",\n              selectionText,\n            });\n          }\n          tooltip.remove();\n\n          return false;\n        });\n      }, 100);\n    });\n  }\n\n  #createTooltip(position) {\n    const id = \"translate-button\";\n    {\n      const tooltip = document.getElementById(id);\n      if (tooltip) {\n        tooltip.remove();\n      }\n    }\n\n    document.body.insertAdjacentHTML(\n      \"beforeend\",\n      `<translate-button id=\"${id}\"></translate-button>`\n    );\n    const tooltip = document.getElementById(id);\n    tooltip.setAttribute(\"position\", JSON.stringify(position));\n\n    document.addEventListener(\n      \"touchstart\",\n      (event) => {\n        if (event.target.closest(id)) {\n          return;\n        }\n        tooltip.remove();\n      },\n      { once: true }\n    );\n\n    return tooltip;\n  }\n\n  #removeTooltip() {\n    const id = \"translate-button\";\n    const tooltip = document.getElementById(id);\n    if (tooltip) {\n      tooltip.remove();\n    }\n  }\n\n  #createToastProgress() {\n    const id = \"toast-progress\";\n    const toast = document.getElementById(id);\n    if (toast) {\n      toast.remove();\n    }\n\n    document.body.insertAdjacentHTML(\n      \"beforeend\",\n      `<toast-progress id=\"${id}\"></toast-progress>`\n    );\n    return document.getElementById(id);\n  }\n\n  #createToastError() {\n    const id = \"toast-error\";\n    const toast = document.getElementById(id);\n    if (toast) {\n      toast.remove();\n    }\n\n    document.body.insertAdjacentHTML(\n      \"beforeend\",\n      `<toast-error id=\"${id}\"></toast-error>`\n    );\n    return document.getElementById(id);\n  }\n\n  #createPopover(position) {\n    const id = \"translate-popover\";\n    {\n      const popover = document.getElementById(id);\n      if (popover) {\n        popover.remove();\n      }\n    }\n\n    document.body.insertAdjacentHTML(\n      \"beforeend\",\n      `<translate-popover id=\"${id}\"></translate-popover>`\n    );\n    const popover = document.getElementById(id);\n    popover.setAttribute(\"position\", JSON.stringify(position));\n    browser.storage.local.get([\"selectedTargetLanguage\"], (result) => {\n      if (result && result.selectedTargetLanguage) {\n        popover.setAttribute(\"lang\", result.selectedTargetLanguage);\n      }\n    });\n\n    const onClick = (event) => {\n      if (event.target.closest(id)) {\n        return;\n      }\n      popover.remove();\n      document.removeEventListener(\"click\", onClick);\n    };\n\n    document.addEventListener(\"click\", onClick);\n    popover.addEventListener(\"close\", async () => {\n      popover.remove();\n      document.removeEventListener(\"click\", onClick);\n    });\n    popover.addEventListener(\"change\", async (event) => {\n      await browser.storage.local.set({\n        selectedSourceLanguage: undefined,\n        selectedTargetLanguage: event.detail.selectedTargetLanguage,\n      });\n    });\n\n    return popover;\n  }\n\n  #getPopover() {\n    const id = \"translate-popover\";\n    return document.getElementById(id);\n  }\n\n  #getExistingPopoverPosition() {\n    const popover = this.#getPopover();\n    if (popover) {\n      const draggable = popover.shadowRoot.querySelector(\"#draggable\");\n      if (draggable) {\n        return {\n          x: draggable.offsetLeft,\n          y: draggable.offsetTop,\n        };\n      }\n    }\n    return undefined;\n  }\n\n  async #translatePage(request) {\n    const translatedElements = document.querySelectorAll(\n      '[data-wtdl-translated=\"false\"]'\n    );\n    if (this.#targetLanguage === request.targetLanguage) {\n      // Restore translated texts\n      for (const element of translatedElements) {\n        const uid = element.dataset.wtdlUid;\n        const translatedText = this.#translatedTexts[uid];\n        element.innerHTML = translatedText;\n        element.dataset.wtdlTranslated = \"true\";\n      }\n    }\n\n    const visibleElements = await collectVisibleElements();\n    if (visibleElements.length === 0) {\n      this.#cancelTranslation();\n      return;\n    }\n    this.#startTranslation();\n\n    const texts = visibleElements.map((element) => element.text);\n    const response = await browser.runtime.sendMessage({\n      method: \"translate\",\n      texts,\n      sourceLanguage: request.sourceLanguage,\n      targetLanguage: request.targetLanguage,\n    });\n\n    const handleError = (error) => {\n      const message =\n        error || browser.i18n.getMessage(\"error_message_generic_error\");\n      this.#abortTranslation(message);\n    };\n\n    if (!response || !response.result) {\n      handleError();\n      return;\n    }\n    const result = response.result.result;\n    if (result && result.texts) {\n      this.#sourceLanguage = result.lang;\n      this.#targetLanguage = request.targetLanguage;\n\n      const translatedTexts = result.texts;\n      if (translatedTexts.length === visibleElements.length) {\n        for (let i = 0; i < visibleElements.length; i++) {\n          const element = visibleElements[i].element;\n          const text = translatedTexts[i].text;\n          const uid = element.dataset.wtdlUid || this.#uid++;\n\n          if (element.dataset.wtdlOriginal !== \"true\") {\n            this.#originalTexts[uid] = element.innerHTML;\n          }\n          this.#translatedTexts[uid] = text;\n          element.innerHTML = text;\n\n          element.dataset.wtdlUid = `${uid}`;\n          element.dataset.wtdlOriginal = \"true\";\n          element.dataset.wtdlTranslated = \"true\";\n        }\n\n        this.#saveState();\n      }\n    } else if (response.result.error) {\n      const message =\n        response.result.error.code === 1045601\n          ? browser.i18n.getMessage(\"error_message_quota_has_been_reached\")\n          : response.result.error.message;\n      handleError(message);\n      return;\n    } else {\n      handleError();\n      return;\n    }\n\n    this.#finishTranslation();\n  }\n\n  #startTranslation() {\n    this.#toastProgress.setAttribute(\"show\", true);\n\n    this.#isProcessing = true;\n    this.#isShowingOriginal = false;\n\n    browser.runtime.sendMessage({\n      method: \"startTranslation\",\n    });\n  }\n\n  #cancelTranslation() {\n    this.#isShowingOriginal = false;\n\n    browser.runtime.sendMessage({\n      method: \"cancelTranslation\",\n      result: {\n        sourceLanguage: this.#sourceLanguage,\n        targetLanguage: this.#targetLanguage,\n      },\n    });\n  }\n\n  #abortTranslation(errorMessage) {\n    this.#isProcessing = false;\n    this.#isShowingOriginal = false;\n\n    this.#toastProgress.setAttribute(\"show\", false);\n    this.#toastError.setAttribute(\"show\", errorMessage);\n\n    browser.runtime.sendMessage({\n      method: \"abortTranslation\",\n      message: errorMessage,\n    });\n  }\n\n  #finishTranslation() {\n    this.#isProcessing = false;\n    this.#toastProgress.setAttribute(\"show\", false);\n\n    browser.runtime.sendMessage({\n      method: \"finishTranslation\",\n      result: {\n        sourceLanguage: this.#sourceLanguage,\n        targetLanguage: this.#targetLanguage,\n      },\n    });\n  }\n}\n\nasync function collectVisibleElements() {\n  const blockElements = [];\n\n  const children = document.body.children;\n  splitElements(children, blockElements);\n\n  const visibleElements = [];\n  for (const element of blockElements) {\n    const visible = isVisible(element);\n    if (\n      visible &&\n      (element.dataset.wtdlUid === undefined ||\n        element.dataset.wtdlTranslated === \"false\")\n    ) {\n      visibleElements.push({ element, text: element.innerHTML });\n    }\n  }\n\n  return visibleElements;\n}\n\nfunction splitElements(elements, storage) {\n  for (const element of elements) {\n    if (isHidden(element)) {\n      continue;\n    }\n    if (element.nodeName === \"svg\") {\n      continue;\n    }\n    if (hasTextNode(element)) {\n      storage.push(element);\n      continue;\n    }\n    if (hasNoBlockElement(element)) {\n      storage.push(element);\n      continue;\n    }\n\n    const children = element.children;\n    if (!children || children.length === 0) {\n      continue;\n    }\n    splitElements(element.children, storage);\n  }\n}\n\nnew App();\n"],"names":["isVisible","element","rect","getBoundingClientRect","top","window","innerHeight","left","innerWidth","isHidden","getComputedStyle","display","textContent","trim","hasTextNode","childNodes","length","child","nodeType","Node","TEXT_NODE","nodeValue","hasNoBlockElement","children","Array","from","every","tagName","this","popover","remove","tooltip","document","getElementById","navigator","maxTouchPoints","msMaxTouchPoints","id","global","dataset","wtdlOriginalTexts","JSON","parse","error","body","insertAdjacentHTML","stringify","browser","runtime","onMessage","addListener","async","request","sender","sendResponse","method","fn","context","result","apply","arguments","undefined","once","callback","isScrolling","refresh","addEventListener","event","clearTimeout","setTimeout","passive","capture","scrollDidStop","sourceLanguage","targetLanguage","isProcessing","Object","keys","isShowingOriginal","elements","querySelectorAll","uid","wtdlUid","originalText","innerHTML","wtdlTranslated","selectionRect","getSelection","getRangeAt","x","scrollX","y","bottom","scrollY","position","setAttribute","texts","text","map","t","join","message","i18n","getMessage","selection","toString","storage","onChanged","changes","areaName","selectedTargetLanguage","newValue","sendMessage","selectionText","preventDefault","rangeCount","textRange","cloneRange","collapse","anchorOffset","focusOffset","right","stopPropagation","target","closest","toast","local","get","onClick","removeEventListener","set","selectedSourceLanguage","detail","draggable","shadowRoot","querySelector","offsetLeft","offsetTop","translatedElements","translatedText","visibleElements","blockElements","splitElements","push","collectVisibleElements","response","handleError","lang","translatedTexts","i","wtdlOriginal","code","errorMessage","nodeName","constructor"],"sourceRoot":""}